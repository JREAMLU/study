package main

import (
	"bytes"
	"crypto/tls"
	"encoding/binary"
	"encoding/hex"
	"encoding/json"
	"errors"
	"fmt"
	"log"
	"net/http"
	"net/url"
	"sync"
	"time"

	"github.com/gorilla/websocket"
)

func main() {
	var roomids = []int64{55668899, 2333333, 1539852, 1539850, 1539837, 1539823, 1539818, 1539815, 1539808, 1539796, 1539780, 1539773, 1539755, 1539700, 1539693, 1539675, 1539672, 1539670, 1539649, 1539639, 1539609, 1539601, 1539596, 1539581, 1539579, 1539574, 1539561, 1539500, 1539482, 1539478, 1539467, 1539463, 1539459, 1539442, 1539436, 1539378, 1539366, 1539353, 1539307, 1539302, 1539295, 1539287, 1539284, 1539274, 1539264, 1539215, 1539167, 1539148, 1539091, 1539050, 1539046, 1539022, 1539004, 1538976, 1538896, 1538791, 1538775, 1538754, 1538749, 1538691, 1538677, 1538417, 1538384, 1538375, 1538347, 1538305, 1538303, 1538274, 1538251, 1538143, 1538110, 1538099, 1538077, 1537988, 1537957, 1537956, 1537933, 1537930, 1537802, 1537739, 1537738, 1537727, 1537602, 1537571, 1537473, 1537436, 1537290, 1537142, 1537019, 1536998, 1536969, 1536908, 1536854, 1536797, 1536774, 1536756, 1536693, 1536681, 1536674, 1536647, 1536610, 1536560, 1536535, 1536507, 1536505, 1536493, 1536397, 1536393, 1536361, 1536314, 1536301, 1536296, 1536274, 1536269, 1536160, 1536100, 1536091, 1535843, 1535732, 1535719, 1535718, 1535686, 1535669, 1535663, 1535598, 1535502, 1535484, 1535270, 1535188, 1535042, 1535025, 1534970, 1534911, 1534753, 1534734, 1534715, 1534630, 1534458, 1534378, 1534269, 1534215, 1534177, 1534085, 1534050, 1534005, 1533954, 1533925, 1533921, 1533864, 1533839, 1533827, 1533823, 1533768, 1533568, 1533500, 1533491, 1533283, 1533270, 1533263, 1533149, 1533107, 1533054, 1532953, 1532870, 1532782, 1532780, 1532754, 1532727, 1532655, 1532402, 1532379, 1532257, 1532253, 1532062, 1531951, 1531863, 1531814, 1531798, 1531634, 1531621, 1531276, 1531131, 1530943, 1530911, 1530862, 1530839, 1530806, 1530774, 1530742, 1530709, 1530702, 1530639, 1530559, 1530538, 1530270, 1530150, 1530142, 1529816, 1529812, 1529797, 1529762, 1529761, 1529751, 1529731, 1529727, 1529712, 1529687, 1529657, 1529647, 1529625, 1529608, 1529605, 1529596, 1529587, 1529569, 1529552, 1529539, 1529537, 1529330, 1529315, 1529095, 1529071, 1529067, 1528783, 1528729, 1528724, 1528590, 1528577, 1528559, 1528553, 1528500, 1528391, 1528302, 1528245, 1528214, 1528141, 1528120, 1528098, 1528052, 1528037, 1528016, 1527939, 1527577, 1527462, 1527429, 1527426, 1527393, 1527312, 1527078, 1527046, 1527038, 1527036, 1527022, 1527011, 1526965, 1526880, 1526875, 1526862, 1526852, 1526847, 1526825, 1526809, 1526766, 1526717, 1526711, 1526698, 1526691, 1526621, 1526584, 1526487, 1526250, 1525949, 1525776, 1525590, 1525487, 1525443, 1525425, 1525382, 1525054, 1525050, 1524956, 1524776, 1524758, 1524338, 1524029, 1524010, 1523994, 1523937, 1523743, 1523668, 1523617, 1523507, 1523269, 1523243, 1523191, 1523164, 1523132, 1523092, 1523068, 1522946, 1522878, 1522741, 1522563, 1522400, 1519950, 1519850, 1519788, 1519733, 1519574, 1519515, 1519502, 1519408, 1519211, 1519208, 1519169, 1519036, 1519028, 1519021, 1518985, 1518932, 1518914, 1518868, 1518665, 1518587, 1518552, 1518320, 1518300, 1518183, 1518132, 1518110, 1518061, 1518014, 1517859, 1517802, 1517689, 1517677, 1517643, 1517557, 1517310, 1517300, 1517297, 1517239, 1517156, 1516989, 1516961, 1516631, 1516421, 1516157, 1516116, 1516084, 1515929, 1515880, 1515873, 1515845, 1515843, 1515842, 1515751, 1515730, 1515713, 1515625, 1515592, 1515547, 1515478, 1515315, 1515103, 1515082, 1515078, 1515073, 1515060, 1514881, 1514743, 1514735, 1514731, 1514711, 1514686, 1514660, 1514601, 1514510, 1514367, 1514263, 1514257, 1514197, 1514183, 1514157, 1514133, 1514095, 1514005, 1513986, 1513695, 1513160, 1512528, 1512268, 1512236, 1512199, 1512196, 1512194, 1512072, 1512001, 1511955, 1511924, 1511920, 1511752, 1511747, 1511746, 1511745, 1511684, 1511651, 1511618, 1511616, 1511615, 1511614, 1511586, 1511577, 1511544, 1511507, 1511439, 1511384, 1511354, 1511325, 1511315, 1511313, 1511254, 1511096, 1511088, 1511051, 1511036, 1511014, 1510955, 1510756, 1510676, 1510581, 1510575, 1510418, 1510205, 1510180, 1510155, 1510080, 1510063, 1510035, 1510019, 1509905, 1509880, 1509860, 1509783, 1509774, 1509736, 1509723, 1509703, 1509693, 1509684, 1509612, 1509601, 1509581, 1509515, 1509395, 1509373, 1509160, 1509143, 1509137, 1508854, 1508710, 1508675, 1508393, 1508328, 1508276, 1508185, 1507857, 1507761, 1507564, 1507552, 1507527, 1506413, 1506225, 1506175, 1506054, 1506023, 1505990, 1505891, 1505773, 1505337, 1505331, 1505246, 1505082, 1504834, 1504758, 1504595, 1504259, 1504067, 1503887, 1503659, 1503413, 1503391, 1503353, 1503206, 1503095, 1502941, 1502930, 1502853, 1502833, 1502269, 1501837, 1501800, 1501612, 1501524, 1500611, 1500593, 1500480, 1500434, 1500236, 1499797, 1499781, 1499723, 1499218, 1499150, 1498603, 1498559, 1498536, 1498341, 1498074, 1496842, 1496453, 1495852, 1495823, 1495764, 1495482, 1495427, 1495322, 1495295, 1494879, 1494415, 1494275, 1493608, 1493565, 1493397, 1493359, 1493266, 1493087, 1492841, 1492631, 1492177, 1491914, 1491908, 1491814, 1491724, 1491693, 1491575, 1491556, 1491358, 1490730, 1490659, 1490547, 1489580, 1489551, 1489275, 1488970, 1488588, 1488509, 1488481, 1488479, 1488379, 1488246, 1488195, 1487458, 1487350, 1487209, 1486896, 1486708, 1486194, 1486187, 1485504, 1485182, 1485178, 1485175, 1484846, 1484621, 1484591, 1484416, 1484364, 1484281, 1483594, 1483507, 1483439, 1483249, 1483225, 1482815, 1482691, 1482350, 1481923, 1481704, 1481394, 1481059, 1480904, 1479766, 1479165, 1479095, 1478512, 1478221, 1477629, 1477504, 1477148, 1477130, 1476447, 1476150, 1476124, 1475831, 1475495, 1474710, 1474665, 1474655, 1474480, 1474129, 1473930, 1472607, 1472339, 1471688, 1471628, 1471264, 1471038, 1470851, 1470821, 1469754, 1469527, 1469519, 1469409, 1469286, 1469253, 1469240, 1469202, 1468562, 1468561, 1468560, 1468558, 1468553, 1468552, 1468551, 1468549, 1468544, 1468541, 1468265, 1468224, 1467446, 1467361, 1467262, 1467082, 1466479, 1466201, 1466044, 1465661, 1465659, 1465657, 1465656, 1465529, 1465232, 1465079, 1464831, 1464388, 1464216, 1464156, 1464155, 1464050, 1463724, 1463584, 1463442, 1463365, 1463194, 1463113, 1462803, 1462768, 1462763, 1462587, 1462470, 1461981, 1461942, 1461788, 1461760, 1461531, 1461250, 1460928, 1460790, 1459615, 1459381, 1458891, 1458753, 1458255, 1457910, 1457884, 1457723, 1457644, 1457601, 1457548, 1457419, 1457209, 1457096, 1457071, 1455920, 1455836, 1455827, 1455491, 1455038, 1454788, 1454056, 1453909, 1453576, 1453240, 1453184, 1453085, 1452896, 1452852, 1452823, 1451732, 1451718, 1451609, 1451541, 1451413, 1450945, 1450944, 1450926, 1450897, 1450629, 1450224, 1449465, 1449272, 1448993, 1448793, 1448771, 1448657, 1448640, 1448503, 1448425, 1448325, 1447975, 1447951, 1447495, 1447480, 1447371, 1447368, 1447231, 1447068, 1446969, 1446464, 1446097, 1445786, 1445137, 1445113, 1445011, 1443914, 1443835, 1443443, 1443421, 1443151, 1443125, 1441864, 1441658, 1441217, 1441085, 1440850, 1440547, 1440330, 1440300, 1440213, 1439978, 1439921, 1439718, 1439601, 1439450, 1439285, 1439118, 1439098, 1438911, 1438794, 1438572, 1438552, 1438311, 1438113, 1437907, 1437838, 1437559, 1437523, 1437467, 1437348, 1436458, 1436240, 1435979, 1435747, 1435506, 1435495, 1435341, 1435250, 1435064, 1435063, 1434337, 1434246, 1434004, 1433949, 1433857, 1433059, 1433033, 1431878, 1431853, 1431573, 1431251, 1431061, 1431033, 1430820, 1430138, 1429891, 1429581, 1429473, 1427683, 1427028, 1426835, 1426708, 1426536, 1426392, 1426230, 1425832, 1425786, 1425691, 1425665, 1425166, 1424977, 1424934, 1424833, 1424336, 1424217, 1424202, 1423794, 1423565, 1423228, 1423125, 1423064, 1422830, 1422633, 1422435, 1422026, 1421758, 1421710, 1421586, 1421373, 1421324, 1421148, 1421140, 1420488, 1420254, 1419575, 1419239, 1419230, 1419001, 1418946, 1418651, 1418038, 1417683, 1417139, 1416946, 1416915, 1416803, 1416693, 1416244, 1415828, 1415146, 1414975, 1414883, 1414582, 1414316, 1414198, 1414180, 1413815, 1413179, 1413125, 1412978, 1412759, 1412546, 1412043, 1411892, 1411696, 1411277, 1411051, 1410438, 1410287, 1409920, 1409844, 1408253, 1408071, 1407934, 1407244, 1407171, 1406852, 1406310, 1406015, 1405840, 1405839, 1405796, 1405600, 1404843, 1404842, 1404840, 1404839, 1404838, 1404781, 1403017, 1402896, 1402836, 1402764, 1402716, 1402636, 1402313, 1402292, 1401913, 1401683, 1401492, 1400962, 1400726, 1400212, 1399851, 1399534, 1399437, 1398538, 1398527, 1398350, 1398179, 1396734, 1396697, 1396560, 1395931, 1395849, 1395297, 1395277, 1395057, 1394794, 1394643, 1394570, 1394353, 1394334, 1393932, 1393202, 1393132, 1392813, 1392512, 1392173, 1391603, 1391445, 1391193, 1390603, 1390540, 1390478, 1389589, 1388983, 1387939, 1387534, 1387512, 1386854, 1386643, 1386009, 1385821, 1385815, 1385795, 1385174, 1385048, 1384929, 1384670, 1384338, 1384278, 1383806, 1383542, 1383244, 1383113, 1382668, 1382151, 1381279, 1380906, 1380864, 1380477, 1380373, 1379493, 1377902, 1377808, 1377627, 1377481, 1377086, 1376382, 1376290, 1376095, 1375955, 1375440, 1375326, 1374754, 1374552, 1374495, 1374413, 1373658, 1373496, 1373389, 1373371, 1373369, 1373297, 1373063, 1372831, 1372300, 1372052, 1372004, 1371550, 1370842, 1369841, 1369575, 1369533, 1369392, 1369391, 1369056, 1368588, 1367914, 1367642, 1367386, 1367236, 1367129, 1367071, 1366426, 1365637, 1365369, 1365128, 1365108, 1365016, 1364965, 1364839, 1364788, 1364621, 1364557, 1364368, 1364290, 1364277, 1363978, 1363135, 1362571, 1362514, 1362453, 1362378, 1362158, 1361552, 1361240, 1360968, 1360628, 1360241, 1359551, 1358746, 1358365, 1358232, 1357627, 1357496, 1357484, 1357364, 1357011, 1356676, 1356372, 1356242, 1355862, 1355367, 1354952, 1354621, 1354190, 1354095, 1354056, 1353947, 1353600, 1353588, 1353468, 1353408, 1352584, 1352470, 1352439, 1351551, 1351249, 1350961, 1350843, 1349892, 1349054, 1348963, 1348623, 1347882, 1347476, 1347351, 1347236, 1346996, 1346693, 1346343, 1346091, 1346060, 1344764, 1344537, 1343958, 1343695, 1343618, 1342925, 1342491, 1342190, 1342013, 1341933, 1341865, 1341782, 1341397, 1340513, 1340070, 1339664, 1339605, 1338941, 1338360, 1338267, 1337311, 1337034, 1336309, 1335196, 1334303, 1332536, 1331846, 1331738, 1331554, 1330620, 1329856, 1329786, 1329269, 1329172, 1329013, 1328857, 1327639, 1327336, 1327176, 1326914, 1326887, 1326792, 1326613, 1326572, 1326490, 1326360, 1326104, 1325887, 1325467, 1324919, 1323125, 1323101, 1323001, 1322873, 1322514, 1320636, 1320228, 1319420, 1318977, 1318797, 1318619, 1318554, 1317430, 1316411, 1316373, 1315752, 1313347, 1313015, 1312943, 1312547, 1312193, 1311986, 1310379, 1310340, 1310184, 1310169, 1309910, 1309357, 1309074, 1308407, 1308390, 1307166, 1306575, 1306368, 1305766, 1305530, 1305407, 1305303, 1304805, 1304754, 1304401, 1303353, 1302981, 1302724, 1302631, 1302610, 1301742, 1301721, 1301409, 1300395, 1300365, 1299768, 1298528, 1298291, 1297930, 1297611, 1297229, 1297118, 1296718, 1296681, 1296232, 1295905, 1295605, 1295546, 1295240, 1295197, 1294453, 1294007, 1293425, 1293289, 1293183, 1293037, 1292600, 1292524, 1291827, 1291641, 1291615, 1291603, 1290720, 1290350, 1289914, 1289656, 1289570, 1289469, 1288787, 1288742, 1288181, 1288033, 1287983, 1287860, 1286739, 1286490, 1286465, 1286107, 1285901, 1285124, 1284988, 1284679, 1284274, 1284244, 1284176, 1283677, 1282956, 1282724, 1281984, 1281925, 1281538, 1281022, 1280787, 1280677, 1280092, 1279248, 1279047, 1277615, 1276823, 1275659, 1275449, 1275283, 1272245, 1271975, 1271571, 1271546, 1271474, 1271440, 1271107, 1271036, 1270822, 1270770, 1270758, 1270564, 1270429, 1270390, 1270038, 1269815, 1269635, 1269629, 1269559, 1268499, 1267941, 1267306, 1267227, 1266566, 1265768, 1265042, 1264369, 1263561, 1262970, 1262820, 1262750, 1261703, 1261275, 1261039, 1260540, 1260539, 1260538, 1260536, 1260535, 1260533, 1260528, 1260363, 1260203, 1259903, 1259808, 1259028, 1258890, 1257975, 1257736, 1257679, 1257509, 1257188, 1257175, 1256943, 1256628, 1255182, 1255042, 1254933, 1254841, 1254024, 1253261, 1252560, 1252449, 1251494, 1249972, 1249139, 1249031, 1248991, 1248912, 1248871, 1248630, 1248030, 1247818, 1247636, 1247291, 1246403, 1246218, 1246122, 1245934, 1245017, 1243834, 1243826, 1243443, 1243406, 1242816, 1242523, 1242470, 1242453, 1242140, 1241922, 1241879, 1241865, 1241174, 1240220, 1228689, 1228653, 1227258, 1226377, 1226107, 1225992, 1225967, 1224348, 1224335, 1223657, 1220634, 1220293, 1218187, 1217935, 1217782, 1217454, 1217016, 1216992, 1216420, 1216404, 1216314, 1216076, 1215296, 1215241, 1215151, 1214420, 1214209, 1213183, 1213088, 1212822, 1212245, 1211655, 1209970, 1209612, 1209608, 1209590, 1209582, 1209421, 1208854, 1208733, 1208606, 1208099, 1206800, 1206717, 1206307, 1205503, 1204953, 1204659, 1204274, 1203980, 1203341, 1203289, 1203287, 1202557, 1201847, 1201554, 1201067, 1200908, 1200142, 1198337, 1198068, 1197707, 1197513, 1196749, 1196744, 1196211, 1195739, 1194295, 1193961, 1193801, 1193033, 1193030, 1192675, 1191800, 1191799, 1191798, 1191797, 1191795, 1191794, 1191791, 1191787, 1191785, 1191783, 1191775, 1191679, 1191262, 1191041, 1190090, 1189862, 1189485, 1189400, 1187983, 1187942, 1186769, 1186759, 1186589, 1186238, 1184948, 1184671, 1184524, 1184399, 1184075, 1183812, 1183770, 1183614, 1181217, 1181082, 1180988, 1180585, 1180275, 1180196, 1179581, 1179128, 1175753, 1175191, 1174909, 1174085, 1174028, 1173990, 1173361, 1173032, 1172085, 1172069, 1170664, 1170219, 1169374, 1169308, 1169303, 1168044, 1167402, 1167088, 1165873, 1165843, 1165386, 1165225, 1165078, 1163297, 1163163, 1162864, 1161466, 1161401, 1161093, 1160253, 1159817, 1159728, 1158937, 1158192, 1157182, 1153381, 1153106, 1152953, 1151657, 1150531, 1150242, 1149509, 1149241, 1148970, 1148730, 1148007, 1147945, 1146389, 1146376, 1145493, 1145014, 1143997, 1143506, 1142804, 1142803, 1139113, 1137753, 1136192, 1135841, 1135171, 1134984, 1134058, 1130878, 1129726, 1129540, 1129376, 1129110, 1127996, 1127604, 1127309, 1126742, 1126370, 1125961, 1124725, 1124471, 1124397, 1124080, 1121623, 1121203, 1120699, 1120697, 1120553, 1120551, 1120550, 1120361, 1120215, 1109691, 1109422, 1109419, 1109287, 1108564, 1107394, 1106409, 1106259, 1106180, 1106131, 1106070, 1106066, 1106029, 1106006, 1105822, 1105643, 1105366, 1104993, 1104595, 1104350, 1104095, 1104071, 1103998, 1102329, 1102322, 1102246, 1102059, 1101963, 1099534, 1099481, 1099104, 1098549, 1097616, 1097396, 1097315, 1096297, 1094979, 1094582, 1094214, 1094116, 1094006, 1092386, 1091924, 1091633, 1091240, 1090619, 1090416, 1090152, 1087865, 1087455, 1087095, 1086083, 1086004, 1085903, 1085866, 1085571, 1084990, 1083340, 1083269, 1082652, 1081572, 1081443, 1081135, 1080988, 1080770, 1080458, 1080363, 1078870, 1078834, 1078735, 1078274, 1076926, 1076840, 1076832, 1074051, 1074029, 1073613, 1073132, 1073033, 1071658, 1071629, 1071549, 1071501, 1071329, 1070694, 1070557, 1069429, 1068790, 1068750, 1068516, 1068443, 1068175, 1067910, 1067424, 1067060, 1065573, 1064150, 1064076, 1063091, 1062705, 1062700, 1062681, 1062334, 1061954, 1061368, 1059706, 1058863, 1058370, 1056694, 1055985, 1055949, 1055848, 1055320, 1055047, 1054290, 1053936, 1053892, 1052815, 1051721, 1051337, 1050243, 1050146, 1049956, 1049308, 1048790, 1048358, 1047502, 1046025, 1045914, 1045816, 1045092, 1044271, 1043604, 1043517, 1043479, 1043316, 1042806, 1042751, 1042162, 1041821, 1040325, 1040023, 1039850, 1039182, 1038160, 1037796, 1037749, 1036973, 1036098, 1035997, 1035417, 1035389, 1034004, 1033793, 1031647, 1030671, 1030670, 1030487, 1030160, 1029769, 1029632, 1029622, 1028865, 1028570, 1028420, 1028405, 1028238, 1027447, 1027203, 1027052, 1026767, 1026696, 1026681, 1026240, 1025945, 1025190, 1024438, 1022435, 1022139, 1021206, 1020376, 1020056, 1019739, 1019617, 1019409, 1018259, 1017750, 1017282, 1017233, 1015573, 1015391, 1014945, 1013328, 1011731, 1010452, 1010023, 1009583, 1009029, 1008328, 1007297, 1006988, 1006722, 1006266, 1005137, 1004591, 1003820, 1003506, 1002712, 1002129, 1002025, 996458, 994070, 993977, 993593, 993270, 992773, 992338, 991539, 991519, 990599, 990361, 990203, 989779, 989502, 989144, 986511, 986117, 986079, 986030, 985934, 985650, 985636, 985601, 985593, 985581, 984886, 983445, 983091, 981931, 981423, 980835, 979279, 978443, 978288, 977572, 976979, 976759, 976459, 976357, 975886, 975835, 975622, 973946, 973156, 970807, 970701, 970614, 970264, 968730, 968588, 968516, 968178, 967669, 967423, 966481, 965991, 965722, 965168, 964702, 964523, 963848, 962408, 961552, 961355, 961052, 960419, 960358, 959893, 957807, 957147, 955814, 954659, 952570, 951785, 951758, 951757, 951455, 950013, 948809, 948788, 948556, 947246, 946943, 946799, 946135, 944039, 942919, 942422, 941433, 938978, 938682, 938158, 936975, 936302, 935199, 935005, 934303, 932536, 932378, 932203, 931807, 930573, 930339, 929709, 929500, 927834, 926180, 925054, 924838, 922539, 922483, 921947, 920823, 920755, 920719, 919199, 918807, 918599, 918531, 918514, 918474, 918350, 917977, 917660, 917632, 917592, 917379, 917257, 916108, 916006, 914913, 911977, 911391, 910898, 910870, 910396, 909805, 909746, 908703, 908508, 907597, 906675, 905980, 904457, 902475, 902184, 900487, 898911, 897673, 897643, 896762, 895017, 893989, 893529, 893374, 892655, 891867, 891824, 890551, 889436, 887241, 887208, 887079, 886105, 885621, 885199, 884827, 883429, 883061, 882480, 882086, 880922, 880716, 880562, 879935, 878039, 877472, 877416, 877024, 875864, 875860, 875855, 875849, 875833, 875545, 875067, 874963, 874809, 874775, 874313, 874110, 873685, 872518, 871439, 871019, 870466, 870176, 868873, 868818, 868758, 868686, 868546, 867473, 865983, 864299, 863564, 863172, 863115, 862905, 862382, 861529, 861311, 861044, 860544, 860516, 859534, 859471, 858986, 856909, 855636, 855429, 854965, 854743, 854272, 854038, 853760, 853449, 853083, 852401, 852351, 851570, 850690, 850117, 849841, 849231, 848420, 847660, 847025, 845880, 845421, 844362, 843951, 843892, 843865, 843734, 843727, 843434, 843062, 842618, 842145, 841582, 841406, 841065, 840943, 839753, 839402, 838661, 837831, 836676, 835595, 834470, 834338, 833526, 833488, 832647, 832502, 831798, 831668, 831279, 831175, 831147, 830929, 830844, 830592, 830035, 828879, 827717, 827534, 827302, 826496, 826338, 826331, 826326, 826235, 826148, 826118, 825459, 825186, 825100, 824945, 824742, 824715, 824015, 823700, 823298, 823180, 823170, 823086, 822878, 822628, 822176, 821392, 821335, 821302, 821301, 820734, 820041, 819696, 819383, 817805, 817632, 817545, 817509, 817255, 816953, 816350, 816246, 815594, 814119, 812793, 811845, 811622, 810627, 810584, 810235, 809610, 809336, 808529, 808344, 808021, 807951, 807881, 806717, 806238, 805986, 805756, 805489, 804861, 804235, 803791, 803640, 802647, 801896, 801540, 799798, 799762, 799677, 798287, 798221, 798152, 796553, 796330, 796242, 796154, 796110, 795851, 795003, 794159, 793848, 793805, 792929, 792901, 792482, 792116, 791522, 790275, 788731, 788568, 787950, 785451, 785299, 785255, 784380, 783540, 783103, 783039, 781688, 781651, 781362, 780995, 780114, 775882, 775872, 775788, 775768, 775493, 775374, 774995, 774157, 773709, 771867, 770664, 770631, 770480, 770335, 769881, 769661, 768962, 768160, 767758, 767409, 766978, 766416, 764964, 764289, 763972, 763955, 763837, 763600, 763556, 763437, 762014, 760546, 760364, 760138, 759420, 758893, 758756, 758190, 758171, 757529, 757334, 756530, 755463, 754870, 754508, 752454, 751980, 751417, 750949, 750153, 750039, 748643, 748610, 748475, 747781, 747563, 745560, 744984, 743978, 743599, 742136, 740610, 739703, 739388, 738307, 738231, 738052, 737943, 737320, 737025, 736304, 736057, 735922, 735616, 734263, 733092, 732799, 730858, 730574, 729664, 728674, 727594, 726379, 726093, 725894, 725879, 725581, 724558, 724360, 723956, 723836, 720937, 720713, 720599, 718276, 717525, 717214, 716242, 716050, 714242, 713912, 713776, 713475, 712536, 711610, 709107, 708814, 708185, 708053, 708003, 707578, 707188, 707125, 705628, 705082, 703746, 702664, 701856, 699894, 699731, 699698, 698206, 698116, 698014, 697690, 695454, 695115, 694331, 692637, 691834, 689795, 689233, 689106, 688424, 687308, 687110, 686044, 686023, 684439, 683990, 683742, 680373, 680284, 680119, 679580, 679297, 677979, 677547, 674899, 672256, 672031, 671803, 671754, 670836, 670655, 669741, 669609, 666666, 664065, 663089, 662609, 662091, 661932, 661355, 661055, 660727, 660662, 659574, 658096, 657279, 657158, 657064, 655463, 655302, 653438, 652745, 652714, 652676, 651871, 651730, 651410, 651259, 650335, 649602, 649533, 649302, 649213, 648245, 647314, 647177, 647062, 646956, 646874, 646853, 646648, 646616, 646300, 646147, 645360, 645329, 644946, 644858, 644838, 644349, 644262, 643977, 643747, 643686, 643598, 643526, 643082, 642285, 642135, 641962, 641841, 641579, 641526, 640811, 640399, 639845, 639799, 639514, 639390, 639043, 638974, 638790, 638754, 638748, 638721, 638684, 638313, 638107, 638105, 637531, 637460, 637429, 637096, 636842, 636057, 635944, 635758, 635626, 635426, 635347, 635341, 635028, 634182, 634144, 633462, 631958, 631600, 631513, 631409, 631396, 631386, 631377, 631193, 630806, 630442, 629771, 628282, 628014, 627906, 627401, 627336, 627277, 627061, 626909, 626864, 626612, 625950, 625910, 625773, 624797, 624535, 624309, 624159, 623832, 623541, 623395, 622983, 622761, 622484, 622310, 621903, 620252, 620208, 620101, 619441, 619271, 619240, 618967, 618734, 618144, 617953, 617909, 617683, 617389, 617385, 617279, 617180, 617086, 617076, 615939, 615639, 615259, 614538, 614519, 614498, 614303, 614233, 614203, 614106, 613669, 613324, 613262, 613032, 612655, 612621, 612261, 611700, 611614, 611307, 610952, 610692, 610617, 610568, 610363, 610049, 609752, 609427, 608641, 608616, 608588, 608560, 608557, 607797, 607501, 607382, 607192, 606607, 606412, 606044, 605734, 605313, 605308, 604932, 604874, 604857, 604099, 604091, 603944, 603886, 603251, 602684, 602510, 602313, 602258, 601976, 601107, 601050, 600786, 600153, 599729, 599619, 599532, 599394, 599297, 599158, 598974, 598965, 598962, 598948, 598254, 598106, 597862, 597787, 597256, 597173, 597017, 596817, 595943, 595640, 595508, 595279, 594966, 594819, 594586, 594343, 593684, 593411, 591398, 591221, 590687, 590566, 589122, 588920, 588691, 588132, 587124, 586475, 586340, 586164, 585356, 585097, 583776, 582891, 582832, 581184, 580798, 580552, 580108, 579168, 578685, 578671, 578648, 578600, 577166, 576750, 576087, 575646, 575602, 574782, 573259, 573063, 572808, 572683, 571842, 571298, 570626, 570461, 570064, 569830, 564778, 564624, 561439, 560953, 557872, 557852, 557247, 557146, 554850, 554049, 553877, 551826, 551790, 551338, 551035, 550770, 550372, 548928, 548568, 548542, 547958, 547003, 546489, 546451, 545305, 542230, 541907, 541497, 541433, 540610, 539568, 539251, 538229, 538126, 537457, 537307, 537087, 536528, 535328, 533128, 532683, 532264, 531913, 531723, 531149, 531093, 530739, 529828, 529578, 528243, 527769, 527602, 527219, 527182, 526136, 525534, 524570, 524158, 523598, 523065, 522640, 519802, 519422, 518630, 518168, 518146, 517229, 516971, 516687, 515636, 515021, 514901, 514009, 513223, 513093, 513085, 512222, 512065, 510945, 510455, 510279, 509546, 508085, 508061, 507986, 506998, 506750, 506552, 506519, 505874, 505682, 505315, 505293, 504427, 504354, 504217, 503172, 502584, 501378, 500816, 498235, 498071, 497990, 497980, 497426, 497071, 497005, 494427, 494392, 494293, 493915, 493301, 493011, 491652, 491505, 491390, 491128, 491124, 490380, 490106, 489880, 489648, 489382, 489162, 489037, 488636, 488208, 487964, 487854, 487524, 487445, 487239, 486897, 486689, 486091, 485061, 484842, 484770, 484512, 484356, 482818, 482737, 480788, 480227, 479283, 476949, 476862, 476848, 476215, 474277, 474085, 473812, 472669, 470731, 470729, 470420, 469552, 469457, 469422, 469332, 467180, 465560, 464412, 463699, 463140, 462729, 462045, 462041, 461396, 461049, 460973, 460457, 460073, 459279, 459069, 458509, 458501, 455840, 455239, 455194, 455055, 454510, 453416, 453109, 453015, 452961, 450614, 450283, 449503, 448916, 448693, 448130, 447267, 445973, 445925, 445186, 445184, 445045, 443699, 443657, 442447, 441741, 441602, 440862, 440475, 439784, 439768, 439624, 439247, 438648, 438253, 437758, 437441, 436658, 436103, 435812, 435501, 435334, 434939, 434620, 434128, 433792, 433472, 431965, 431753, 431063, 430909, 430192, 429886, 429826, 429810, 428849, 427388, 427342, 426990, 425792, 425495, 424420, 424051, 423299, 423124, 421955, 421284, 419584, 419055, 418271, 416170, 415041, 414172, 413925, 412260, 411568, 410352, 410261, 409846, 409237, 409217, 408807, 408118, 407372, 406945, 406336, 406285, 406277, 406229, 406087, 406001, 405806, 405457, 405136, 404677, 404506, 404356, 404045, 403144, 402731, 402051, 401901, 401562, 401142, 399796, 399566, 398087, 398025, 396213, 395977, 395370, 395126, 394921, 394897, 394405, 393198, 392794, 392394, 391707, 390098, 389856, 388942, 388753, 388392, 386925, 386744, 385903, 385688, 385477, 385007, 384463, 378790, 376973, 375338, 375241, 375021, 374994, 374598, 374407, 374319, 372310, 371037, 370550, 370069, 369711, 367136, 366798, 366722, 364628, 364221, 360780, 360534, 359507, 359501, 359158, 358049, 356874, 356130, 353600, 353101, 352848, 352572, 351877, 351624, 351562, 350606, 349951, 349350, 347964, 346883, 346342, 344168, 343788, 342624, 341977, 341879, 341870, 341408, 340622, 340040, 338475, 338326, 337852, 337261, 335832, 334648, 331550, 329422, 328976, 328150, 327473, 326033, 325122, 325085, 324909, 323961, 323243, 321666, 320838, 320528, 320202, 318900, 318618, 318598, 317675, 317380, 317297, 316289, 315780, 315734, 315669, 315295, 314755, 314661, 314412, 314403, 314061, 312911, 312180, 311544, 311027, 309984, 309969, 309689, 308085, 307412, 306150, 306063, 305860, 304735, 304429, 303437, 302507, 301485, 301481, 301109, 300729, 300178, 299160, 297988, 297842, 294484, 292963, 292336, 292122, 290761, 290067, 288128, 287297, 287081, 284994, 284473, 284059, 283951, 283874, 279105, 278807, 278701, 278208, 278103, 277777, 277196, 276712, 276485, 276428, 274903, 273786, 272887, 271881, 271390, 271197, 269737, 269348, 269221, 268856, 268675, 268291, 268200, 268136, 264919, 264144, 263693, 262741, 262499, 261729, 261013, 260699, 259796, 258386, 258079, 257225, 256483, 255848, 253877, 253644, 253095, 252618, 249838, 245311, 244810, 244618, 243508, 243502, 243340, 241872, 241792, 241479, 241262, 240774, 240503, 239069, 236142, 236116, 233546, 231881, 231128, 230424, 228435, 226283, 224945, 224796, 224588, 224317, 223679, 223192, 222222, 219973, 218890, 218673, 218273, 217467, 216907, 216057, 215386, 214709, 214136, 213329, 212558, 212128, 212023, 209608, 207572, 205988, 204634, 202566, 201495, 200802, 200198, 197697, 197689, 196627, 196499, 196392, 194544, 194049, 193677, 187594, 187213, 185305, 184830, 183130, 183037, 181260, 180194, 180132, 177348, 175812, 174927, 173846, 172798, 172511, 171252, 170739, 169350, 169099, 165624, 164194, 162766, 160723, 160695, 159975, 159893, 159326, 158491, 156095, 155146, 154689, 153122, 152979, 151788, 149099, 146360, 144249, 144069, 143373, 142667, 141274, 140630, 140628, 138083, 137667, 137241, 137138, 136025, 135903, 135146, 134382, 132426, 130231, 127644, 127552, 124640, 122842, 122582, 118493, 117194, 115083, 110953, 110285, 108489, 108025, 107662, 105091, 103675, 103301, 103122, 101715, 99999, 98134, 97962, 97580, 97513, 97411, 96895, 96831, 95893, 94927, 92575, 92055, 91719, 90295, 89539, 88911, 88191, 87835, 87729, 87421, 86859, 86201, 85195, 84995, 84713, 82823, 80983, 80593, 80281, 79243, 78323, 78071, 77777, 77515, 77295, 77273, 76915, 76765, 76539, 75849, 74243, 73671, 73621, 72723, 71491, 70991, 70829, 68223, 67735, 67545, 66977, 66507, 65217, 64805, 63375, 62725, 62005, 61971, 61537, 61505, 60997, 60993, 60737, 60709, 59843, 58127, 57753, 56779, 56181, 56103, 55666, 55221, 54945, 54549, 54091, 52871, 50921, 50165, 49373, 48975, 48963, 47745, 47743, 44813, 44155, 43461, 43243, 42905, 42793, 41873, 41487, 40473, 39105, 38735, 38421, 37595, 37527, 37229, 36683, 35983, 35123, 34023, 33861, 33325, 33225, 32757, 32611, 32393, 31131, 30517, 30239, 29935, 29413, 29193, 27503, 27403, 26803, 26601, 26103, 26063, 25525, 25513, 24991, 24707, 24461, 24441, 24185, 24163, 23795, 23333, 23325, 22161, 21989, 21961, 21911, 20641, 20487, 19693, 19241, 18627, 18609, 18339, 18263, 18261, 18199, 18000, 17501, 17379, 17273, 17269, 16975, 16847, 16769, 16693, 16631, 16217, 16177, 16037, 15719, 15659, 15445, 15405, 14935, 14915, 14827, 14755, 14365, 14341, 14339, 14243, 13877, 13781, 13711, 13657, 13653, 13383, 13161, 13133, 13131, 13031, 12969, 12245, 12045, 12043, 11989, 11895, 11857, 11845, 11797, 11521, 11365, 11071, 10971, 10963, 10953, 10455, 10447, 10417, 10405, 10371, 10305, 10287, 10121, 10055, 10027, 10019, 9999, 7000, 5000, 4003, 3001, 307}

	for _, rid := range roomids {
		go room(rid)
		time.Sleep(3 * time.Second)
	}
	select {}
}

// var wsConn *websocket.Conn
var Lives = make(map[int64]struct{})
var mx sync.Mutex

func room(roomid int64) {
	// var roomid int64

	// 获取房间信息
	param, err := getChatParam(roomid)
	if err != nil {
		return
	}

	websocketAddr := param.ChatAddrList[0]
	u := url.URL{Scheme: "wss", Host: websocketAddr, Path: "/"}

	origin := "https://www.panda.tv"
	wsHeaders := http.Header{
		"Origin": {origin},
	}

	wd := websocket.Dialer{
		HandshakeTimeout: time.Second * 5,
		TLSClientConfig: &tls.Config{
			InsecureSkipVerify: true,
		},
		Proxy: http.ProxyFromEnvironment,
	}

	wsConn, _, err := wd.Dial(u.String(), wsHeaders)
	if err != nil {
		log.Fatal("fail-dial:", roomid, err)
	}
	log.Printf("%v - 连接服务器成功, ws地址列表: %v, 当前使用的地址: %v", roomid, param.ChatAddrList, websocketAddr)

	mx.Lock()
	Lives[roomid] = struct{}{}
	mx.Unlock()

	var liveList []int64
	for rid := range Lives {
		liveList = append(liveList, rid)
	}
	log.Printf("正在监听的房间号:%v 列表 总数 %v 列表 %v", roomid, len(liveList), liveList)

	defer func() {
		if x := recover(); x != nil {
			log.Printf("recover: %v", x)
		}

		mx.Lock()
		delete(Lives, roomid)
		mx.Unlock()

		log.Printf("%v 房间退出", roomid)

		wsConn.WriteMessage(websocket.CloseMessage, websocket.FormatCloseMessage(websocket.CloseNormalClosure, "88"))
		wsConn.Close()
	}()

	// handshake
	handshake(param, wsConn)

	// keepAlive
	keepAlive(roomid, wsConn)

	for {
		n, message, err := wsConn.ReadMessage()
		if err != nil {
			log.Printf("%v - failed-read: %v - %v - %v", roomid, err, n, string(message))
			return
		}

		msg, err := dealMessage(message)
		if err != nil {
			log.Printf("%v - failed-recv err: %s %v", roomid, msg, err)
			return
		}

		log.Printf("%v - recv: %s %v", roomid, msg, err)
	}
}

var pandaStart = []byte{0x00, 0x06, 0x00, 0x02}
var pandaHeartbeat = []byte{0x00, 0x06, 0x00, 0x00}
var pandaResponse = []byte{0x00, 0x06, 0x00, 0x06} //连接弹幕服务器响应
var pandaReceiveMsg = []byte{0x00, 0x06, 0x00, 0x03}
var pandaHeartbeatResponse = []byte{0x00, 0x06, 0x00, 0x01}

var KeepAliveInterval = time.Minute

const pandaIgnoreByteLength = 12 //弹幕消息体忽略的字节数
const pandaMetaByteLength = 4    //meta

type PandaChatParam struct {
	Rid          int64    `json:"rid"`
	Appid        string   `json:"appid"`
	Ts           int64    `json:"ts"`
	Sign         string   `json:"sign"`
	AuthType     string   `json:"authType"`
	ChatAddrList []string `json:"chat_addr_list"`
}

type pandaChatData struct {
	Data PandaChatParam `json:"data"`
}

func getChatParam(roomid int64) (*PandaChatParam, error) {
	u := fmt.Sprintf("http://riven.panda.tv/chatroom/getinfo?roomid=%d&protocol=ws", roomid)
	var chatData pandaChatData
	err := GetJson(u, &chatData)
	if err != nil {
		return nil, err
	}

	return &chatData.Data, nil
}

func GetJson(url string, v interface{}) error {
	req, _ := http.NewRequest("GET", url, nil)
	req.Header.Set("User-Agent", "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36")
	client := &http.Client{}
	resp, err := client.Do(req)
	if err != nil {
		fmt.Println("get error ", url, err)
		return err
	}

	if resp.StatusCode != http.StatusOK || resp.Body == nil {
		fmt.Println("status code error ", url, resp.StatusCode)
		return errors.New(fmt.Sprint("status code ", resp.StatusCode))
	}

	defer resp.Body.Close()
	d := json.NewDecoder(resp.Body)
	err = d.Decode(v)
	if err != nil {
		fmt.Println("json error ", url, err)
		return err
	}

	return nil
}

func handshake(param *PandaChatParam, wsConn *websocket.Conn) error {
	data := fmt.Sprintf("u:%d@%s\nk:1\nt:300\nts:%d\nsign:%s\nauthtype:%s", param.Rid, param.Appid, param.Ts, param.Sign, param.AuthType)
	l := len(data)

	msg := make([]byte, 4+2+l)
	copy(msg, pandaStart)
	binary.BigEndian.PutUint16(msg[4:], uint16(l))
	copy(msg[4+2:], []byte(data))
	err := wsConn.WriteMessage(websocket.BinaryMessage, msg)
	if err != nil {
		return err
	}
	n, buff, err := wsConn.ReadMessage()
	if err != nil {
		return err
	}
	if n != websocket.BinaryMessage || !bytes.Equal(buff[:4], pandaResponse) {
		return errors.New("response error")
	}
	log.Printf("%v - 第一次读取信息成功: %v", param.Rid, buff[:4])

	length := int((uint(buff[4]) << 8) + uint(buff[5]))
	if length > 255 {
		return errors.New("invalid response length flag")
	}
	n, buff2, err := wsConn.ReadMessage()
	if len(buff2) == 0 {
		return errors.New("invalid response recv")
	}
	if n == websocket.BinaryMessage || bytes.Equal(buff2[:4], pandaReceiveMsg) {
		log.Printf("%v - 第二次读取服务器成功, 开始接收弹幕消息: %v %v", param.Rid, buff2[:4], buff2)
	}

	return nil
}

var typeStart = []byte(`{"type"`)

func dealMessage(buff []byte) (string, error) {
	if bytes.Equal(buff[:4], pandaHeartbeatResponse) {
		return "", nil
	}

	l := len(buff)
	if l <= 4 {
		return "", errors.New("no deal")
	}

	if bytes.Equal(buff[:4], pandaReceiveMsg) {
		if l < 4+2 {
			return "", errors.New("msg length + body not enough")
		}

		length := uint(buff[4]<<8) + uint(buff[5])
		pos := int(4 + 2 + length)
		if l < pos+4+pandaIgnoreByteLength {
			return "", errors.New("l < pos+4+pandaIgnoreByteLength")
		}

		msgLen := int(binary.BigEndian.Uint32(buff[pos:]))
		if l < pos+4+msgLen {
			return "", errors.New("l < pos+4+msgLen")
		}
		pos += 4 + pandaIgnoreByteLength
		strBytes := buff[pos : pos+msgLen-pandaIgnoreByteLength]

		// 弹幕有时有bug，多条消息并在一起，需要拆开
		var n = 0
		for {
			n = bytes.LastIndex(strBytes, typeStart)
			if n == -1 {
				// for ugly string like
				// {"data":{"content":{"val":5819.173616,"c_lv":14,"c_lv_val":5180,"n_lv":15,"n_lv_val":6449},"to":{"toRoom":"66666"},"from":{}},"type":"212"}
				n = bytes.LastIndex(strBytes, []byte(`{"data"`))
				if n == -1 {
					fmt.Println("invalid string", string(strBytes))
					break
				}
			}
			str := string(strBytes[n:])
			return str, nil
			if n == 0 {
				break
			}
			strBytes = strBytes[:n-pandaIgnoreByteLength]
		}

	} else if bytes.Equal(buff[:4], pandaHeartbeatResponse) {
		return "", nil
	}

	log.Printf("%v", hex.EncodeToString(buff[:4]))
	return "", nil
}

func keepAlive(roomid int64, wsConn *websocket.Conn) {
	go func() {
		for {
			wsConn.PingHandler()

			err := wsConn.WriteMessage(websocket.BinaryMessage, pandaHeartbeat)
			if err != nil {
				log.Printf("%v-房间 退出心跳 周期 %v, err: %v", roomid, KeepAliveInterval, err)
				return
			}
			log.Printf("%v-房间 发送心跳 周期 %v, err: %v", roomid, KeepAliveInterval, err)
			time.Sleep(KeepAliveInterval)
		}
	}()
}
